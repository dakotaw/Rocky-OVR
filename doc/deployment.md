# Deploying the rocky app

For a complete custom deployment, many of the files in `app/assets` and
`config/locales` should be customized to your brand.

The rocky web application can be run in one of two general modes - either 'CORE' or 'UI'.
A rocky application running in CORE mode handles partner access and setup, registrantion
API requests and PDF generation, serving and management. The UI version of the application
provides a UI workflow for registrants to enter data that is based on state-specific
and partner-provided rules and prefences, but ultimately submits an API request to a
CORE system and doesn't store any persistent data.

The CORE system is made up of one or more linux servers and the UI system is expected
to be run on Heroku. 

The CORE system can be made up of one or more web servers, up to one util server and any number of pdfgen servers. The database can be hosted on any of these servers, though ideally is separate.
The web server(s) run the actual web application and handle all web requests. Outside of the main
web application there are serveral scheduled tasks that run periodically and a couple of daemons that
process data as it comes in. The scheduled tasks should only be configured to run on one server
and generally these run on the single instance of the util server. However, if necessary, it's
possible to run these on the same system as the web server. The daemons can be run as many times and
in as many places as needed in order to process incoming data most efficiently. A general CORE system
will consiste of 1 or 2 webservers, a util server running the scheduled tasks and a couple daemons for pdf processing and at least 1 pdfgen server that only runs daemons for pdf processing. All of these servers
must be set up to share a filesystem or have a portion of the filesystem synched so that the web server 
can directly serve PDF files generated by the util and pdfgen servers. 

The UI system is run on heroku and, after the general heroku configuration is complete, the deploy scripts
should handle any other necessary set up.


## 1. CORE servers configuration

Any servers set up as part of a CORE system should be linux servers and the following peices
should be configured. 

### 1a. ssh

To simplify the initial deploy process, all servers should
be configured to allow ssh connections to github without needing a user to
manually accept github as a known host. This can be done by adding the following
into the deployment users' `~/.ssh/config` file on both the web and util servers.

    Host github.com
      User git
      StrictHostKeyChecking no
      BatchMode yes
      IdentityFile /home/rocky/.ssh/id_rsa

### 1b. Installation requirements

Install dependencies for CentOS/RHEL:

    yum install apr-devel apr-util-devel gcc-c++ httpd-devel ImageMagick-devel \
      libcurl-devel libxslt-devel libyaml-devel mysql-devel perl-DBD-MySQL \
      perl-DBI perl-XML-Simple zlib-devel

### 1c. Apache

The capistrano deploy:setup task makes an assumption that the server will be
using rvm, apache2 and passenger. The apache config file for the site should be
created assuming certain path values for gems and modules installed by
RVM/gem/passenger during the cap deploy tasks.

The parts of these paths depend on:

* ruby version (currently 1.9.3-p125, specified in `.ruby-version`)
* gemset name (currently rocky4, specified in `.ruby-gemset`)
* passenger version (currently 3.0.19, specified in `config/deploy.rb` in the :install_passenger task)

If the gemset, ruby version or passenger version changes the paths in the apache
config file will need to change. This should not be a common occurrence.

### 1d. cron

There are thre cron jobs (generally ran on the utility server). One redacts sensitive data from abandoned registrations, another removes old pdfs from the file system after 15 days. (Or however many days
is indicated in the configuration), and the third sends any pending reminder emails. They will generally look
like this, but the frequency can vary from deployment to deployment:

    */10 * * * * rocky /var/www/register.rockthevote.com/rocky/current/script/cron_timeout_stale_registrations staging2
    */5  * * * * rocky /var/www/register.rockthevote.com/rocky/current/script/cron_remove_buckets staging2
    0    * * * * rocky /var/www/register.rockthevote.com/rocky/current/script/cron_mail_reminders production
    

### 1e. Email

Email to registrants is sent by the cron_mail_remeinders task (on whichever server it is running from) and email to partners for e.g. password reset is sent from the web server.


## 2. Heroku configuration

Describe how to set up the heroku branch stuff


## 3. Application settings and Data


### 3a. Importing State Data

The application is set up to import updates to state-specific data. You'll want
to do this once before launching, then whenever changes are necessary. You can
do this by updating the states.yml file in your repository and by doing a full
deploy.



## 4. Configure deploy scripts

The `rocky` application is set up to be deployed using capistrano with
multistage. The repository contains the generic `config/deploy.rb` file with
the main set of procedures for a deployment and there are a number of
environment-specific files in `config/deploy/`. These files just contain a few
settings which reference environment variables. These variables need to be set
in your `.env` file (which only needs to exist on your development machine, or
wherever you run your cap scripts from). See `.env.example` for a list of what
values need to be specified.


## 5. Deploy

### a. Setup (rvm/passenger)

The servers should be configured with all the required software libraries before
running this. They should also have their directory system set up according to
the configuration in the local .env file.)

Running the capistrano `deploy:setup` task will also invoke a number of custom
tasks (see `config/deploy.rb`) that will install RVM, ruby (the version
indicated in `.ruby-version`), set up a gemset (the gemset indicated in
`.ruby-gemset`), install passenger into that gemset, and run the
passenger-install-apache2-module script.

### b. Deploy (various symlinks)

Before running the first deploy, the deployment directory should have a shared/
directory set up with the following files:

* `shared/config/database.yml`
* `shared/config/newrelic.yml`
* `shared/.env.<env>`

When your code changes are pushed to git origin/master, run

    $ cap <environment_name> deploy

To deploy a specific tag or commit (highly recommended):

    $ cap <environment_name> deploy -Srev=<commit-hash|tag|branch>

### c. Utility Daemons

There are two worker daemons running on the utility server. They can be managed
locally with control scripts or remotely with capistrano.

    $ script/rocky_runner start
    $ script/rocky_runner stop
    $ script/rocky_pdf_runner start
    $ script/rocky_pdf_runner stop

    $ cap deploy:run_workers      # start/restart rocky_runner
    $ cap deploy:run_pdf_workers  # start/restart rocky_pdf_runner
    
The `deploy:run_workers` and`deploy:run_pdf_workers` tasks also run during a full deploy


#### `rocky_runner`

The `rocky_runner` daemon pulls jobs out of the delayed job queue and runs them.
There are two kinds of jobs: completing a registration and sending a reminder
email. Completing the registration includes generating the PDF, which uses the
second daemon to do that work.

#### `rocky_pdf_runner`

It would be nice to have both daemons merged into one process, but it was faster
to set things up this way. In the future, using JRuby would let someone do
that. For now, we use the second daemon to avoid paying the cost of launching a
Java VM for every PDF merger.